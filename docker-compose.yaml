version: '3.8'

services:
  # ==================== КЛАСТЕР ETCD (3 ноды) ====================
  etcd0:
    image: bitnami/etcd:3
    container_name: etcd0
    environment:
      - ETCD_NAME=etcd0
      - ETCD_INITIAL_ADVERTISE_PEER_URLS=http://etcd0:2380
      - ETCD_LISTEN_PEER_URLS=http://0.0.0.0:2380
      - ETCD_LISTEN_CLIENT_URLS=http://0.0.0.0:2379
      - ETCD_ADVERTISE_CLIENT_URLS=http://etcd0:2379
      - ETCD_INITIAL_CLUSTER_TOKEN=etcd-cluster-audit
      - ETCD_INITIAL_CLUSTER=etcd0=http://etcd0:2380,etcd1=http://etcd1:2380,etcd2=http://etcd2:2380
      - ETCD_INITIAL_CLUSTER_STATE=new
    networks:
      - patroni-net
    healthcheck:
      test: ["CMD", "etcdctl", "endpoint", "health"]
      interval: 10s
      timeout: 5s
      retries: 3

  etcd1:
    image: bitnami/etcd:3
    container_name: etcd1
    environment:
      - ETCD_NAME=etcd1
      - ETCD_INITIAL_ADVERTISE_PEER_URLS=http://etcd1:2380
      - ETCD_LISTEN_PEER_URLS=http://0.0.0.0:2380
      - ETCD_LISTEN_CLIENT_URLS=http://0.0.0.0:2379
      - ETCD_ADVERTISE_CLIENT_URLS=http://etcd1:2379
      - ETCD_INITIAL_CLUSTER_TOKEN=etcd-cluster-audit
      - ETCD_INITIAL_CLUSTER=etcd0=http://etcd0:2380,etcd1=http://etcd1:2380,etcd2=http://etcd2:2380
      - ETCD_INITIAL_CLUSTER_STATE=new
    networks:
      - patroni-net
    healthcheck:
      test: ["CMD", "etcdctl", "endpoint", "health"]
      interval: 10s
      timeout: 5s
      retries: 3

  etcd2:
    image: bitnami/etcd:3
    container_name: etcd2
    environment:
      - ETCD_NAME=etcd2
      - ETCD_INITIAL_ADVERTISE_PEER_URLS=http://etcd2:2380
      - ETCD_LISTEN_PEER_URLS=http://0.0.0.0:2380
      - ETCD_LISTEN_CLIENT_URLS=http://0.0.0.0:2379
      - ETCD_ADVERTISE_CLIENT_URLS=http://etcd2:2379
      - ETCD_INITIAL_CLUSTER_TOKEN=etcd-cluster-audit
      - ETCD_INITIAL_CLUSTER=etcd0=http://etcd0:2380,etcd1=http://etcd1:2380,etcd2=http://etcd2:2380
      - ETCD_INITIAL_CLUSTER_STATE=new
    networks:
      - patroni-net
    healthcheck:
      test: ["CMD", "etcdctl", "endpoint", "health"]
      interval: 10s
      timeout: 5s
      retries: 3

  # ==================== КЛАСТЕР POSTGRESQL + PATRONI (3 ноды) ====================
  patroni-0:
    build: ./patroni
    container_name: patroni-0
    restart: always
    environment:
      - PATRONI_SCOPE=audit-cluster
      - PATRONI_NAME=patroni-0
      - PATRONI_ETCD_HOSTS=etcd0:2379,etcd1:2379,etcd2:2379
      - PATRONI_POSTGRESQL_CONNECT_ADDRESS=patroni-0:5432
      - PATRONI_POSTGRESQL_LISTEN=0.0.0.0:5432
      - PATRONI_POSTGRESQL_DATA_DIR=/var/lib/postgresql/data/pgdata
      - PATRONI_REPLICATION_USERNAME=replicator
      - PATRONI_REPLICATION_PASSWORD=${POSTGRES_REPLICATION_PASSWORD}
      - PATRONI_SUPERUSER_USERNAME=postgres
      - PATRONI_SUPERUSER_PASSWORD=${POSTGRES_SUPERUSER_PASSWORD}
      - PATRONI_admin_PASSWORD=${POSTGRES_ADMIN_PASSWORD}
      - PATRONI_RESTAPI_CONNECT_ADDRESS=patroni-0:8008
      - PATRONI_RESTAPI_LISTEN=0.0.0.0:8008
    ports:
      - "5432:5432"  # Для отладки (primary)
    volumes:
      - patroni_data_0:/var/lib/postgresql/data
    networks:
      - patroni-net
    depends_on:
      etcd0:
        condition: service_healthy
      etcd1:
        condition: service_healthy
      etcd2:
        condition: service_healthy

  patroni-1:
    build: ./patroni
    container_name: patroni-1
    restart: always
    environment:
      - PATRONI_SCOPE=audit-cluster
      - PATRONI_NAME=patroni-1
      - PATRONI_ETCD_HOSTS=etcd0:2379,etcd1:2379,etcd2:2379
      - PATRONI_POSTGRESQL_CONNECT_ADDRESS=patroni-1:5432
      - PATRONI_POSTGRESQL_LISTEN=0.0.0.0:5432
      - PATRONI_POSTGRESQL_DATA_DIR=/var/lib/postgresql/data/pgdata
      - PATRONI_REPLICATION_USERNAME=replicator
      - PATRONI_REPLICATION_PASSWORD=${POSTGRES_REPLICATION_PASSWORD}
      - PATRONI_SUPERUSER_USERNAME=postgres
      - PATRONI_SUPERUSER_PASSWORD=${POSTGRES_SUPERUSER_PASSWORD}
      - PATRONI_admin_PASSWORD=${POSTGRES_ADMIN_PASSWORD}
      - PATRONI_RESTAPI_CONNECT_ADDRESS=patroni-1:8008
      - PATRONI_RESTAPI_LISTEN=0.0.0.0:8008
    ports:
      - "5433:5432"  # Для отладки
    volumes:
      - patroni_data_1:/var/lib/postgresql/data
    networks:
      - patroni-net
    depends_on:
      etcd0:
        condition: service_healthy
      etcd1:
        condition: service_healthy
      etcd2:
        condition: service_healthy

  patroni-2:
    build: ./patroni
    container_name: patroni-2
    restart: always
    environment:
      - PATRONI_SCOPE=audit-cluster
      - PATRONI_NAME=patroni-2
      - PATRONI_ETCD_HOSTS=etcd0:2379,etcd1:2379,etcd2:2379
      - PATRONI_POSTGRESQL_CONNECT_ADDRESS=patroni-2:5432
      - PATRONI_POSTGRESQL_LISTEN=0.0.0.0:5432
      - PATRONI_POSTGRESQL_DATA_DIR=/var/lib/postgresql/data/pgdata
      - PATRONI_REPLICATION_USERNAME=replicator
      - PATRONI_REPLICATION_PASSWORD=${POSTGRES_REPLICATION_PASSWORD}
      - PATRONI_SUPERUSER_USERNAME=postgres
      - PATRONI_SUPERUSER_PASSWORD=${POSTGRES_SUPERUSER_PASSWORD}
      - PATRONI_admin_PASSWORD=${POSTGRES_ADMIN_PASSWORD}
      - PATRONI_RESTAPI_CONNECT_ADDRESS=patroni-2:8008
      - PATRONI_RESTAPI_LISTEN=0.0.0.0:8008
    ports:
      - "5434:5432"  # Для отладки
    volumes:
      - patroni_data_2:/var/lib/postgresql/data
    networks:
      - patroni-net
    depends_on:
      etcd0:
        condition: service_healthy
      etcd1:
        condition: service_healthy
      etcd2:
        condition: service_healthy

  # ==================== HAProxy для PostgreSQL ====================
  haproxy:
    image: haproxy:2.8-alpine
    container_name: haproxy-db
    ports:
      - "15432:5432"  # Primary endpoint для записи
      - "15433:5433"  # Read replicas endpoint
      - "5000:5000"   # Статистика HAProxy
    volumes:
      - ./haproxy/haproxy.cfg:/usr/local/etc/haproxy/haproxy.cfg:ro
    networks:
      - patroni-net
      - backend-net
    depends_on:
      - patroni-0
      - patroni-1
      - patroni-2

  # ==================== МИКРОСЕРВИС АУДИТА (3 инстанса) ====================
  audit-service-1:
    build: ./audit-service
    container_name: audit-service-1
    environment:
      - APP_PORT=8080
      - DB_HOST=haproxy
      - DB_PORT=15432
      - DB_USER=postgres
      - DB_PASSWORD=${POSTGRES_SUPERUSER_PASSWORD}
      - DB_NAME=audit_db
      - LOG_LEVEL=INFO
      - APP_VERSION=1.0.0
    networks:
      - backend-net
      - frontend-net
    depends_on:
      haproxy:
        condition: service_started
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    restart: unless-stopped

  audit-service-2:
    build: ./audit-service
    container_name: audit-service-2
    environment:
      - APP_PORT=8080
      - DB_HOST=haproxy
      - DB_PORT=15432
      - DB_USER=postgres
      - DB_PASSWORD=${POSTGRES_SUPERUSER_PASSWORD}
      - DB_NAME=audit_db
      - LOG_LEVEL=INFO
      - APP_VERSION=1.0.0
    networks:
      - backend-net
      - frontend-net
    depends_on:
      haproxy:
        condition: service_started
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    restart: unless-stopped

  audit-service-3:
    build: ./audit-service
    container_name: audit-service-3
    environment:
      - APP_PORT=8080
      - DB_HOST=haproxy
      - DB_PORT=15432
      - DB_USER=postgres
      - DB_PASSWORD=${POSTGRES_SUPERUSER_PASSWORD}
      - DB_NAME=audit_db
      - LOG_LEVEL=INFO
      - APP_VERSION=1.0.0
    networks:
      - backend-net
      - frontend-net
    depends_on:
      haproxy:
        condition: service_started
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    restart: unless-stopped

  # ==================== NGINX API GATEWAY ====================
  nginx:
    build: ./nginx
    container_name: nginx-gateway
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    networks:
      - frontend-net
    depends_on:
      audit-service-1:
        condition: service_healthy
      audit-service-2:
        condition: service_healthy
      audit-service-3:
        condition: service_healthy
    restart: unless-stopped

volumes:
  patroni_data_0:
  patroni_data_1:
  patroni_data_2:

networks:
  patroni-net:
    driver: bridge
  backend-net:
    driver: bridge
  frontend-net:
    driver: bridge